<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coberturas bibliográficas por carrera</title>
    <!-- Carga de Tailwind CSS para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de fuentes de Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <!-- Carga de Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
        }
        /* Aplicando la nueva fuente a los títulos */
        h1, h2 {
            font-weight: 700;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 1.5rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
            padding: 1.5rem;
        }
        .career-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr); /* Default para móviles */
            gap: 1rem;
        }
        @media (min-width: 640px) { /* sm */
            .career-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (min-width: 1024px) { /* lg */
            .career-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        .percent-cell {
            padding: 0.5rem;
            border-radius: 0.5rem; /* rounded-lg */
            text-align: center;
            font-weight: 500;
            color: white;
            transition: transform 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 80px; /* Asegura altura mínima para el texto */
        }
        .percent-cell:hover {
            transform: scale(1.05);
        }

        /* Clases de utilidad para los porcentajes */
        .percent-high { background-color: #059669; }
        .percent-medium-high { background-color: #10B981; }
        .percent-medium { background-color: #F59E0B; }
        .percent-low { background-color: #EF4444; }
        
        /* Estilo para el logo */
        .logo-container {
            position: absolute;
            top: 0;
            left: 0;
            padding: 1rem;
            z-index: 1000;
        }
        .logo-container img {
            max-height: 60px;
            width: auto;
            border-radius: 0.5rem;
        }

        /* Estilos para la barra de progreso */
        .progress-bar-bg {
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            height: 1.5rem;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            border-radius: 0.5rem;
            transition: width 0.5s ease-in-out;
            text-align: center;
            color: white;
            font-weight: bold;
            line-height: 1.5rem;
        }
        
        /* Estilos para la lista desplegable de títulos faltantes */
        details > summary {
            cursor: pointer;
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details > summary::before {
            content: '►';
            margin-right: 0.5rem;
            display: inline-block;
            transition: transform 0.2s;
        }
        details[open] > summary::before {
            transform: rotate(90deg);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="logo-container">
        <img src="https://raw.githubusercontent.com/pazrioseco/DashboardCRAI/main/LOGO%20CRAI.png" alt="Logo" onerror="this.onerror=null; this.src='https://placehold.co/150x60/cccccc/ffffff?text=Logo';" class="rounded-md">
    </div>

    <div class="container pt-24">
        <h1 class="text-4xl font-bold text-center text-gray-800 mb-8 md:mb-12">Coberturas bibliográficas por carrera</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="card">
                <label for="faculty-filter" class="block text-lg font-medium mb-2">Filtrar por Facultad:</label>
                <select id="faculty-filter" class="block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-md">
                    <option value="all">Todas las Facultades</option>
                </select>
            </div>
            <div class="card">
                <label for="career-filter" class="block text-lg font-medium mb-2">Filtrar por Carrera:</label>
                <select id="career-filter" class="block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-md">
                    <option value="all">Todas las Carreras</option>
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="card text-center flex flex-col justify-center"><p class="text-sm font-semibold text-gray-500 uppercase leading-tight">Bibliografía Básica<br>Títulos Únicos</p><p id="avg-bbas-unique" class="text-4xl font-bold text-teal-600 mt-2">N/A</p></div>
            <div class="card text-center flex flex-col justify-center"><p class="text-sm font-semibold text-gray-500 uppercase leading-tight">Bibliografía Complementaria<br>Títulos Únicos</p><p id="avg-bcom-unique" class="text-4xl font-bold text-sky-600 mt-2">N/A</p></div>
            <div class="card text-center flex flex-col justify-center"><p class="text-sm font-semibold text-gray-500 uppercase leading-tight">Bibliografía Básica<br>Formato electrónico</p><p id="avg-bbas-ebooks" class="text-4xl font-bold text-indigo-600 mt-2">N/A</p></div>
            <div class="card text-center flex flex-col justify-center"><p class="text-sm font-semibold text-gray-500 uppercase leading-tight">Bibliografía Complementaria<br>Formato electrónico</p><p id="avg-bcom-ebooks" class="text-4xl font-bold text-rose-600 mt-2">N/A</p></div>
        </div>

        <div class="card mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Cobertura porcentual por carrera</h2>
            <div class="flex flex-wrap justify-center items-center gap-x-6 gap-y-2 mb-6 text-sm text-gray-600 border-t border-b py-3 bg-gray-50 rounded-md">
                <span class="font-semibold mr-4">Leyenda:</span>
                <div class="flex items-center"><span class="w-4 h-4 rounded mr-2 percent-high"></span><span>90% o más</span></div>
                <div class="flex items-center"><span class="w-4 h-4 rounded mr-2 percent-medium-high"></span><span>80% - 89%</span></div>
                <div class="flex items-center"><span class="w-4 h-4 rounded mr-2 percent-medium"></span><span>70% - 79%</span></div>
                <div class="flex items-center"><span class="w-4 h-4 rounded mr-2 percent-low"></span><span>Menos de 70%</span></div>
            </div>
            <div id="career-cards-container" class="career-grid">
                <p class="col-span-full text-center text-gray-500" id="cards-placeholder">Selecciona una facultad o carrera para ver los datos.</p>
            </div>
        </div>
        
        <div class="card mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Detalle: Títulos Requeridos vs. Existentes</h2>
            <div id="comparison-cards-container" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <p class="col-span-full text-center text-gray-500" id="comparison-cards-placeholder">Selecciona una carrera específica para ver el detalle.</p>
            </div>
        </div>

        <div class="card">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Carreras en rediseño</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="card bg-gray-50">
                    <label for="redesign-faculty-filter" class="block text-lg font-medium mb-2">Filtrar por Facultad:</label>
                    <select id="redesign-faculty-filter" class="block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-md">
                        <option value="all">Todas las Facultades</option>
                    </select>
                </div>
                <div class="card bg-gray-50">
                    <label for="redesign-career-filter" class="block text-lg font-medium mb-2">Filtrar por Carrera:</label>
                    <select id="redesign-career-filter" class="block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-md">
                        <option value="all">Todas las Carreras</option>
                    </select>
                </div>
            </div>
            <div id="redesign-career-container" class="space-y-6">
                <p class="col-span-full text-center text-gray-500" id="redesign-placeholder">Selecciona una facultad o carrera para ver los datos.</p>
            </div>
        </div>
    </div>

    <script>
        const data = [
            // Facultad de Administración y Negocios
            { 
                faculty: "Facultad de Administración y Negocios", 
                career: "INGENIERÍA COMERCIAL", 
                bbas_unique_percent: 97, 
                bcom_unique_percent: 96, 
                bbas_ebooks_percent: 41, 
                bcom_ebooks_percent: 46, 
                required_basic: 113, 
                required_bcom: 106, 
                existing_basic: 110, 
                existing_bcom: 102, 
                missing_basic_titles: [
                    { asignatura: 'ESPECIALIDAD V: NEGOCIACIÓN EFECTIVA', title: 'Del Conflicto A La Conciliación', author: 'MERLAINO, Jorge y NEGRET M, César', reason: 'Descatalogado' },
                    { asignatura: 'JUEGO DE NEGOCIos', title: 'Manual de la aplicación, última edición, disponible en la aplicación', author: '', reason: 'Referencia con información incompleta' },
                    { asignatura: 'ESPECIALIDAD IV: HERRAMIENTAS DE GESTION ERP', title: 'Material De Formación Sistema Erp', author: '', reason: 'Referencia con información incompleta' }
                ],
                missing_bcom_titles: [
                    { asignatura: 'DERECHO EMPRESARIAL', title: 'Apuntes de Joel González Castillo, Teoría de la Ley, Actos jurídicos, Bienes.', author: '', reason: 'No disponible' },
                    { asignatura: 'ESPECIALIDAD IV: HERRAMIENTAS DE GESTION ERP', title: 'Apuntes entregados por el profesor a través de Sagaf (Aula Virtual)', author: '', reason: 'Referencia con información incompleta' },
                    { asignatura: 'DESAFÍOS DE LA INGENIERÍA COMERCIAL', title: 'La gerencia de empresas', author: 'DRUCKER, Peter', reason: 'Descatalogado' },
                    { asignatura: 'ESPECIALIDAD V: NEGOCIACIÓN EFECTIVA', title: 'La Negociación Racional en un Mundo Irracional', author: 'BAZERMAN, Max. y NEALE, Margaret', reason: 'Descatalogado' }
                ]
            },
            { faculty: "Facultad de Administración y Negocios", career: "INGENIERÍA EN ADMINISTRACIÓN", bbas_unique_percent: 91, bcom_unique_percent: 89, bbas_ebooks_percent: 51, bcom_ebooks_percent: 43, required_basic: 81, required_bcom: 63, existing_basic: 74, existing_bcom: 56 },
            { faculty: "Facultad de Administración y Negocios", career: "INGENIERÍA EN CONTROL DE GESTIÓN", bbas_unique_percent: 92, bcom_unique_percent: 89, bbas_ebooks_percent: 52, bcom_ebooks_percent: 38, required_basic: 117, required_bcom: 146, existing_basic: 108, existing_bcom: 130 },
            // Facultad de Arquitectura, Construcción y Medio Ambiente
            { faculty: "Facultad de Arquitectura, Construcción y Medio Ambiente", career: "ARQUITECTURA", bbas_unique_percent: 92, bcom_unique_percent: 90, bbas_ebooks_percent: 20, bcom_ebooks_percent: 29, required_basic: 85, required_bcom: 99, existing_basic: 78, existing_bcom: 89 },
            { faculty: "Facultad de Arquitectura, Construcción y Medio Ambiente", career: "INGENIERÍA EN CONSTRUCCIÓN", bbas_unique_percent: 92, bcom_unique_percent: 96, bbas_ebooks_percent: 41, bcom_ebooks_percent: 48, required_basic: 103, required_bcom: 98, existing_basic: 95, existing_bcom: 94 },
            // Facultad de Ciencias de la Salud
            { faculty: "Facultad de Ciencias de la Salud", career: "ENFERMERÍA", bbas_unique_percent: 98, bcom_unique_percent: 98, bbas_ebooks_percent: 54, bcom_ebooks_percent: 52, required_basic: 99, required_bcom: 107, existing_basic: 97, existing_bcom: 105 },
            { faculty: "Facultad de Ciencias de la Salud", career: "ODONTOLOGÍA", bbas_unique_percent: 94, bcom_unique_percent: 93, bbas_ebooks_percent: 31, bcom_ebooks_percent: 29, required_basic: 109, required_bcom: 117, existing_basic: 103, existing_bcom: 109 },
            { faculty: "Facultad de Ciencias de la Salud", career: "FONOAUDIOLOGÍA", bbas_unique_percent: 96, bcom_unique_percent: 92, bbas_ebooks_percent: 12, bcom_ebooks_percent: 11, required_basic: 100, required_bcom: 119, existing_basic: 96, existing_bcom: 110 },
            { faculty: "Facultad de Ciencias de la Salud", career: "KINESIOLOGÍA", bbas_unique_percent: 98, bcom_unique_percent: 98, bbas_ebooks_percent: 10, bcom_ebooks_percent: 7, required_basic: 104, required_bcom: 113, existing_basic: 102, existing_bcom: 111 },
            { faculty: "Facultad de Ciencias de la Salud", career: "MEDICINA", bbas_unique_percent: 94, bcom_unique_percent: 89, bbas_ebooks_percent: 36, bcom_ebooks_percent: 33, required_basic: 116, required_bcom: 150, existing_basic: 109, existing_bcom: 134 },
            { faculty: "Facultad de Ciencias de la Salud", career: "NUTRICIÓN Y DIETÉTICA", bbas_unique_percent: 93, bcom_unique_percent: 94, bbas_ebooks_percent: 8, bcom_ebooks_percent: 6, required_basic: 103, required_bcom: 139, existing_basic: 96, existing_bcom: 131 },
            { faculty: "Facultad de Ciencias de la Salud", career: "OBSTETRICIA Y PUERICULTURA", bbas_unique_percent: 97, bcom_unique_percent: 97, bbas_ebooks_percent: 9, bcom_ebooks_percent: 10, required_basic: 88, required_bcom: 92, existing_basic: 85, existing_bcom: 89 },
            { faculty: "Facultad de Ciencias de la Salud", career: "QUÍMICA Y FARMACIA", bbas_unique_percent: 94, bcom_unique_percent: 94, bbas_ebooks_percent: 11, bcom_ebooks_percent: 10, required_basic: 89, required_bcom: 100, existing_basic: 84, existing_bcom: 94 },
            { faculty: "Facultad de Ciencias de la Salud", career: "TERAPIA OCUPACIONAL", bbas_unique_percent: 96, bcom_unique_percent: 96, bbas_ebooks_percent: 5, bcom_ebooks_percent: 5, required_basic: 112, required_bcom: 132, existing_basic: 107, existing_bcom: 127 },
            // Facultad de Ciencias Sociales y Humanidades
            { faculty: "Facultad de Ciencias Sociales y Humanidades", career: "PSICOLOGÍA", bbas_unique_percent: 98, bcom_unique_percent: 93, bbas_ebooks_percent: 42, bcom_ebooks_percent: 46, required_basic: 131, required_bcom: 177, existing_basic: 129, existing_bcom: 165 },
            { faculty: "Facultad de Ciencias Sociales y Humanidades", career: "ADMINISTRACIÓN PÚBLICA", bbas_unique_percent: 94, bcom_unique_percent: 91, bbas_ebooks_percent: 61, bcom_ebooks_percent: 59, required_basic: 137, required_bcom: 219, existing_basic: 129, existing_bcom: 200 },
            { faculty: "Facultad de Ciencias Sociales y Humanidades", career: "PERIODISMO", bbas_unique_percent: 95, bcom_unique_percent: 92, bbas_ebooks_percent: 37, bcom_ebooks_percent: 46, required_basic: 136, required_bcom: 140, existing_basic: 129, existing_bcom: 129 },
            { faculty: "Facultad de Ciencias Sociales y Humanidades", career: "PUBLICIDAD PROFESIONAL Y COMUNICACIÓN INTEGRAL", bbas_unique_percent: 93, bcom_unique_percent: 87, bbas_ebooks_percent: 30, bcom_ebooks_percent: 26, required_basic: 99, required_bcom: 137, existing_basic: 92, existing_bcom: 119 },
            { faculty: "Facultad de Ciencias Sociales y Humanidades", career: "TRABAJO SOCIAL", bbas_unique_percent: 94, bcom_unique_percent: 97, bbas_ebooks_percent: 47, bcom_ebooks_percent: 54, required_basic: 113, required_bcom: 159, existing_basic: 106, existing_bcom: 154 },
            // Facultad de Derecho
            { faculty: "Facultad de Derecho", career: "DERECHO", bbas_unique_percent: 97, bcom_unique_percent: 98, bbas_ebooks_percent: 61, bcom_ebooks_percent: 43, required_basic: 113, required_bcom: 126, existing_basic: 110, existing_bcom: 123 },
            // Facultad de Educación
            { faculty: "Facultad de Educación", career: "LICENCIATURA EN ARTES VISUALES", bbas_unique_percent: 79, bcom_unique_percent: 88, bbas_ebooks_percent: 20, bcom_ebooks_percent: 26, required_basic: 92, required_bcom: 103, existing_basic: 73, existing_bcom: 91 },
            { faculty: "Facultad de Educación", career: "PEDAGOGÍA EN CASTELLANO", bbas_unique_percent: 90, bcom_unique_percent: 89, bbas_ebooks_percent: 36, bcom_ebooks_percent: 40, required_basic: 127, required_bcom: 178, existing_basic: 114, existing_bcom: 158 },
            { faculty: "Facultad de Educación", career: "PEDAGOGÍA EN EDUCACIÓN BÁSICA", bbas_unique_percent: 86, bcom_unique_percent: 93, bbas_ebooks_percent: 42, bcom_ebooks_percent: 45, required_basic: 121, required_bcom: 162, existing_basic: 104, existing_bcom: 151 },
            { faculty: "Facultad de Educación", career: "PEDAGOGÍA EN EDUCACIÓN DIFERENCIAL", bbas_unique_percent: 88, bcom_unique_percent: 90, bbas_ebooks_percent: 44, bcom_ebooks_percent: 49, required_basic: 112, required_bcom: 155, existing_basic: 99, existing_bcom: 139 },
            { faculty: "Facultad de Educación", career: "PEDAGOGÍA EN EDUCACIÓN FÍSICA", bbas_unique_percent: 95, bcom_unique_percent: 92, bbas_ebooks_percent: 50, bcom_ebooks_percent: 55, required_basic: 119, required_bcom: 131, existing_basic: 113, existing_bcom: 121 },
            { faculty: "Facultad de Educación", career: "PEDAGOGÍA EN HISTORIA, GEOGRAFÍA Y CIENCIAS SOCIALES", bbas_unique_percent: 91, bcom_unique_percent: 91, bbas_ebooks_percent: 35, bcom_ebooks_percent: 42, required_basic: 123, required_bcom: 178, existing_basic: 112, existing_bcom: 162 },
            { faculty: "Facultad de Educación", career: "PEDAGOGÍA EN INGLÉS", bbas_unique_percent: 95, bcom_unique_percent: 95, bbas_ebooks_percent: 31, bcom_ebooks_percent: 31, required_basic: 106, required_bcom: 127, existing_basic: 101, existing_bcom: 121 },
            { faculty: "Facultad de Educación", career: "PEDAGOGÍA EN EDUCACIÓN PARVULARIA", bbas_unique_percent: 95, bcom_unique_percent: 95, bbas_ebooks_percent: 56, bcom_ebooks_percent: 53, required_basic: 102, required_bcom: 114, existing_basic: 97, existing_bcom: 108 },
            // Facultad de Ingeniería
            { faculty: "Facultad de Ingeniería", career: "INGENIERÍA CIVIL INDUSTRIAL", bbas_unique_percent: 92, bcom_unique_percent: 94, bbas_ebooks_percent: 43, bcom_ebooks_percent: 46, required_basic: 127, required_bcom: 131, existing_basic: 117, existing_bcom: 123 },
            { faculty: "Facultad de Ingeniería", career: "INGENIERÍA CIVIL INFORMÁTICA", bbas_unique_percent: 95, bcom_unique_percent: 92, bbas_ebooks_percent: 48, bcom_ebooks_percent: 43, required_basic: 133, required_bcom: 144, existing_basic: 126, existing_bcom: 133 },
            { faculty: "Facultad de Ingeniería", career: "INGENIERÍA CIVIL QUÍMICA", bbas_unique_percent: 86, bcom_unique_percent: 86, bbas_ebooks_percent: 38, bcom_ebooks_percent: 34, required_basic: 103, required_bcom: 112, existing_basic: 89, existing_bcom: 96 },
        ];

        const redesignData = [
            {
                faculty: "Facultad de Derecho", 
                career: "DERECHO", 
                bbas_unique_percent: 97, 
                bcom_unique_percent: 98, 
                bbas_ebooks_percent: 47, 
                bcom_ebooks_percent: 65, 
                required_basic: 117, 
                required_bcom: 124, 
                existing_basic: 113, 
                existing_bcom: 121
            }
        ];

        data.sort((a, b) => a.faculty.localeCompare(b.faculty) || a.career.localeCompare(b.career));

        window.onload = () => {
            const facultyFilter = document.getElementById('faculty-filter');
            const careerFilter = document.getElementById('career-filter');
            const avgBbasUniqueEl = document.getElementById('avg-bbas-unique');
            const avgBcomUniqueEl = document.getElementById('avg-bcom-unique');
            const avgBbasEbooksEl = document.getElementById('avg-bbas-ebooks');
            const avgBcomEbooksEl = document.getElementById('avg-bcom-ebooks');
            const careerCardsContainer = document.getElementById('career-cards-container');
            const cardsPlaceholder = document.getElementById('cards-placeholder');
            
            const comparisonCardsContainer = document.getElementById('comparison-cards-container');
            const comparisonCardsPlaceholder = document.getElementById('comparison-cards-placeholder');

            const redesignFacultyFilter = document.getElementById('redesign-faculty-filter');
            const redesignCareerFilter = document.getElementById('redesign-career-filter');
            const redesignContainer = document.getElementById('redesign-career-container');


            function initializeFilters(filterElement, data, careerFilterElement) {
                if (!filterElement) return;
                const faculties = [...new Set(data.map(item => item.faculty))].sort();
                faculties.forEach(faculty => {
                    const option = document.createElement('option');
                    option.value = faculty;
                    option.textContent = faculty;
                    filterElement.appendChild(option);
                });
                 if(careerFilterElement){
                    updateCareerFilter(filterElement, careerFilterElement, data);
                }
            }
            
            function updateCareerFilter(facultyFilter, careerFilter, sourceData) {
                const selectedFaculty = facultyFilter.value;
                careerFilter.innerHTML = '<option value="all">Todas las Carreras</option>';
                
                const careersToShow = (selectedFaculty === 'all') 
                    ? sourceData 
                    : sourceData.filter(item => item.faculty === selectedFaculty);
                
                const uniqueCareers = [...new Set(careersToShow.map(item => item.career))].sort();

                uniqueCareers.forEach(career => {
                    const option = document.createElement('option');
                    option.value = career;
                    option.textContent = career;
                    careerFilter.appendChild(option);
                });
            }


            function updateVisualizations() {
                const selectedFaculty = facultyFilter.value;
                const selectedCareer = careerFilter.value;
                const filteredData = data.filter(item => 
                    (selectedFaculty === 'all' || item.faculty === selectedFaculty) &&
                    (selectedCareer === 'all' || item.career === selectedCareer)
                );
                updateKPIs(filteredData);
                updateCareerCards(filteredData);
                updateComparisonCards(filteredData);
            }

            function calculateAverage(data, key) {
                const validItems = data.filter(item => typeof item[key] === 'number' && !isNaN(item[key]));
                if (validItems.length === 0) return 'N/A';
                const total = validItems.reduce((sum, item) => sum + item[key], 0);
                return `${(total / validItems.length).toFixed(1)}%`;
            }
            
            function updateKPIs(currentData) {
                avgBbasUniqueEl.textContent = calculateAverage(currentData, 'bbas_unique_percent');
                avgBcomUniqueEl.textContent = calculateAverage(currentData, 'bcom_unique_percent');
                avgBbasEbooksEl.textContent = calculateAverage(currentData, 'bbas_ebooks_percent');
                avgBcomEbooksEl.textContent = calculateAverage(currentData, 'bcom_ebooks_percent');
            }

            function getHeatmapColorClass(percentage) {
                if (typeof percentage !== 'number' || isNaN(percentage)) return 'percent-unavailable';
                if (percentage >= 90) return 'percent-high';
                if (percentage >= 80) return 'percent-medium-high';
                if (percentage >= 70) return 'percent-medium';
                return 'percent-low';
            }

            function updateCareerCards(currentData) {
                careerCardsContainer.innerHTML = '';
                if (currentData.length === 0) {
                    careerCardsContainer.appendChild(cardsPlaceholder);
                    cardsPlaceholder.classList.remove('hidden');
                    return;
                }
                cardsPlaceholder.classList.add('hidden');

                currentData.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'card flex flex-col justify-between';
                    const formatPercent = (p) => (typeof p === 'number' ? `${p}%` : 'N/A');
                    card.innerHTML = `
                        <div class="text-center"><p class="text-sm font-semibold text-gray-500 mb-1">${item.faculty}</p><p class="text-xl font-bold text-gray-900 mb-4">${item.career}</p></div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="percent-cell ${getHeatmapColorClass(item.bbas_unique_percent)}"><p class="text-xs font-semibold">BBAS Títulos únicos</p><p class="text-lg font-bold">${formatPercent(item.bbas_unique_percent)}</p></div>
                            <div class="percent-cell ${getHeatmapColorClass(item.bcom_unique_percent)}"><p class="text-xs font-semibold">BCOM Títulos únicos</p><p class="text-lg font-bold">${formatPercent(item.bcom_unique_percent)}</p></div>
                            <div class="percent-cell ${getHeatmapColorClass(item.bbas_ebooks_percent)}"><p class="text-xs font-semibold">BBAS Formato electrónico</p><p class="text-lg font-bold">${formatPercent(item.bbas_ebooks_percent)}</p></div>
                            <div class="percent-cell ${getHeatmapColorClass(item.bcom_ebooks_percent)}"><p class="text-xs font-semibold">BCOM Formato electrónico</p><p class="text-lg font-bold">${formatPercent(item.bcom_ebooks_percent)}</p></div>
                        </div>`;
                    careerCardsContainer.appendChild(card);
                });
            }
            
            function updateComparisonCards(currentData) {
                comparisonCardsContainer.innerHTML = '';
                if (currentData.length === 1) {
                    const careerData = currentData[0];
                    comparisonCardsPlaceholder.classList.add('hidden');
                    const createComparisonCard = (title, existing, required, missingTitles) => {
                        const coverage = (required > 0) ? (existing / required) * 100 : 0;
                        const card = document.createElement('div');
                        card.className = 'p-4 border rounded-lg bg-gray-50 flex flex-col';
                        let missingTitlesHtml = '';
                        if (missingTitles && missingTitles.length > 0) {
                            const listItems = missingTitles.map(t => `<li class="border-b py-2"><span class="block font-semibold text-sm text-gray-600">${t.asignatura}</span><span class="font-semibold">${t.title}</span><br><span class="text-xs italic">${t.author || 'Autor no especificado'}</span><br><span class="text-xs text-red-600">${t.reason}</span></li>`).join('');
                            missingTitlesHtml = `
                                <details class="mt-4"><summary class="text-sm font-semibold text-blue-600 hover:underline">Ver Títulos Faltantes (${missingTitles.length})</summary>
                                    <ul class="list-none mt-2 pl-2 text-sm text-gray-700 bg-white p-2 rounded max-h-48 overflow-y-auto border">
                                        ${listItems}
                                    </ul>
                                </details>`;
                        }
                        card.innerHTML = `
                            <div>
                                <h3 class="font-bold text-lg text-gray-700">${title}</h3>
                                <p class="text-gray-600 mt-2">Existentes: <span class="font-bold">${existing}</span> de <span class="font-bold">${required}</span> Requeridos</p>
                                <div class="flex items-center mt-3">
                                    <div class="w-full progress-bar-bg"><div class="progress-bar-fill ${getHeatmapColorClass(coverage)}" style="width: ${coverage.toFixed(2)}%;">${coverage.toFixed(1)}%</div></div>
                                </div>
                            </div>
                            <div class="mt-auto pt-2">${missingTitlesHtml}</div>`;
                        return card;
                    };
                    const basicCard = createComparisonCard('Bibliografía Básica', careerData.existing_basic, careerData.required_basic, careerData.missing_basic_titles);
                    const bcomCard = createComparisonCard('Bibliografía Complementaria', careerData.existing_bcom, careerData.required_bcom, careerData.missing_bcom_titles);
                    comparisonCardsContainer.appendChild(basicCard);
                    comparisonCardsContainer.appendChild(bcomCard);
                } else {
                    comparisonCardsContainer.appendChild(comparisonCardsPlaceholder);
                    comparisonCardsPlaceholder.classList.remove('hidden');
                }
            }

            function updateRedesignVisualizations() {
                redesignContainer.innerHTML = '';
                const selectedFaculty = redesignFacultyFilter.value;
                const selectedCareer = redesignCareerFilter.value;

                const filteredData = redesignData.filter(item => 
                    (selectedFaculty === 'all' || item.faculty === selectedFaculty) &&
                    (selectedCareer === 'all' || item.career === selectedCareer)
                );

                if(filteredData.length === 0){
                    redesignContainer.innerHTML = `<p class="text-center text-gray-500">No hay datos para la selección actual.</p>`;
                    return;
                }

                filteredData.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'card border-l-4 border-blue-500';
                    card.innerHTML = `
                        <p class="text-sm font-semibold text-gray-500 mb-1 text-center">${item.faculty}</p>
                        <p class="text-xl font-bold text-gray-900 mb-4 text-center">${item.career}</p>
                        <div class="grid grid-cols-2 gap-3 mb-6">
                            <div class="percent-cell ${getHeatmapColorClass(item.bbas_unique_percent)}"><p class="text-[11px] leading-tight font-semibold">BBAS<br>Títulos únicos</p><p class="text-lg font-bold">${item.bbas_unique_percent}%</p></div>
                            <div class="percent-cell ${getHeatmapColorClass(item.bcom_unique_percent)}"><p class="text-[11px] leading-tight font-semibold">BCOM<br>Títulos únicos</p><p class="text-lg font-bold">${item.bcom_unique_percent}%</p></div>
                            <div class="percent-cell ${getHeatmapColorClass(item.bbas_ebooks_percent)}"><p class="text-[11px] leading-tight font-semibold">BBAS<br>Formato electrónico</p><p class="text-lg font-bold">${item.bbas_ebooks_percent}%</p></div>
                            <div class="percent-cell ${getHeatmapColorClass(item.bcom_ebooks_percent)}"><p class="text-[11px] leading-tight font-semibold">BCOM<br>Formato electrónico</p><p class="text-lg font-bold">${item.bcom_ebooks_percent}%</p></div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="p-4 border rounded-lg bg-gray-50 flex flex-col">
                                <h3 class="font-bold text-lg text-gray-700">Bibliografía Básica</h3>
                                <p class="text-gray-600 mt-2">Existentes: <span class="font-bold">${item.existing_basic}</span> de <span class="font-bold">${item.required_basic}</span> Requeridos</p>
                                <div class="flex items-center mt-3">
                                    <div class="w-full progress-bar-bg"><div class="progress-bar-fill ${getHeatmapColorClass(item.bbas_unique_percent)}" style="width: ${item.bbas_unique_percent}%;">${item.bbas_unique_percent}%</div></div>
                                </div>
                            </div>
                            <div class="p-4 border rounded-lg bg-gray-50 flex flex-col">
                                <h3 class="font-bold text-lg text-gray-700">Bibliografía Complementaria</h3>
                                <p class="text-gray-600 mt-2">Existentes: <span class="font-bold">${item.existing_bcom}</span> de <span class="font-bold">${item.required_bcom}</span> Requeridos</p>
                                <div class="flex items-center mt-3">
                                    <div class="w-full progress-bar-bg"><div class="progress-bar-fill ${getHeatmapColorClass(item.bcom_unique_percent)}" style="width: ${item.bcom_unique_percent}%;">${item.bcom_unique_percent}%</div></div>
                                </div>
                            </div>
                        </div>
                    `;
                    redesignContainer.appendChild(card);
                });
            }

            // Event listeners
            if (facultyFilter) facultyFilter.addEventListener('change', () => {
                updateCareerFilter(facultyFilter, careerFilter, data);
                updateVisualizations();
            });
            if (careerFilter) careerFilter.addEventListener('change', updateVisualizations);
            
            if (redesignFacultyFilter && redesignCareerFilter) {
                redesignFacultyFilter.addEventListener('change', () => updateCareerFilter(redesignFacultyFilter, redesignCareerFilter, redesignData));
                redesignCareerFilter.addEventListener('change', updateRedesignVisualizations);
            }

            initializeFilters(facultyFilter, data, careerFilter);
            if(redesignFacultyFilter && redesignCareerFilter) {
                initializeFilters(redesignFacultyFilter, redesignData, redesignCareerFilter);
            }
            updateVisualizations(); // Carga inicial
            updateRedesignVisualizations(); // Carga inicial para rediseño
        };
    </script>   
</body>
</html>
